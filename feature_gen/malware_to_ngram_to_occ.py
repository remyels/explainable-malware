import heapq
import os
import pandas
import pickle
import shutil
import zipfile

df = pandas.read_csv("trainLabels.csv")
for malware in df['Id']:
	# Extract malwares individually
	filename = "train/" + malware + ".bytes"
	print(filename)
	with zipfile.ZipFile('train.zip') as z:
		with z.open(filename) as zf, open(malware+".bytes", 'wb') as f:
			shutil.copyfileobj(zf, f)

	dictogram = {}
	f = open(malware+".bytes", "r")
	all_bytes = []
	for line in f:
		all_bytes += "".join(filter(lambda x: (x!='00') & (x!='??'), line.rstrip().split(" ")[1:]))
	grams_as_string = "".join(all_bytes)
	four_grams = [grams_as_string[i:i+4] for i in range(len(grams_as_string)-3)]
	for x in four_grams: 
		if x in dictogram: 
			dictogram[x] += 1
		else: 
			dictogram[x] = 1 

	# Save features 
	pickle.dump(dictogram, open("malware_ngrams/{}_{}.pickle".format(str(malware), str(df.loc[df['Id'] == malware].iloc[0].Class)), "wb"))

	# Delete extracted malware
	f.close()
	os.remove(malware+".bytes") 
